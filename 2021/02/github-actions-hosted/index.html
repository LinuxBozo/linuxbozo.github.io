<!doctype html><html lang=en-us><head><title>Self-hosted GitHub Actions: The missing bits // wtf, linuxbozo</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.80.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="M. Adam Kendall"><meta name=description content="The missing bits that aren't well documented when using self-hosted Github Actions runners"><link rel=stylesheet href=https://linuxbozo.github.io/css/main.min.b6ad1e947f04a3a8688af7a8df58ddeae41a50d5ccf5d2043aae22c9122a464d.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Self-hosted GitHub Actions: The missing bits"><meta name=twitter:description content="The missing bits that aren't well documented when using self-hosted Github Actions runners"><meta property="og:title" content="Self-hosted GitHub Actions: The missing bits"><meta property="og:description" content="The missing bits that aren't well documented when using self-hosted Github Actions runners"><meta property="og:type" content="article"><meta property="og:url" content="https://linuxbozo.github.io/2021/02/github-actions-hosted/"><meta property="article:published_time" content="2021-02-15T14:41:29-05:00"><meta property="article:modified_time" content="2021-02-15T23:05:16-05:00"></head><body><header class=app-header><a href=https://linuxbozo.github.io/><img class=app-header-avatar src=/avatar.jpg alt="M. Adam Kendall"></a><h1>wtf, linuxbozo</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about/>About</a>
▪︎
<a class=app-header-menu-item href=/>Home</a>
▪︎
<a class=app-header-menu-item href=/tags/>Tags</a></nav><p>maker + coder + devops + beer + bourbon - bullshit.</p><div class=app-header-social><a target=_blank href=https://github.com/linuxbozo rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/linuxbozo rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a target=_blank href=https://instagram.com/linuxbozo rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-instagram"><title>instagram</title><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Self-hosted GitHub Actions: The missing bits</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Feb 15, 2021</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><a class=tag href=https://linuxbozo.github.io/tags/github/>github</a>
<a class=tag href=https://linuxbozo.github.io/tags/github-actions/>github-actions</a>
<a class=tag href=https://linuxbozo.github.io/tags/self-hosted/>self-hosted</a></div></div></header><div class=post-content><p>Having your own self-hosted GitHub Actions runner can be advantageous for quite a few reasons. Perhaps you need longer running jobs (a separate discussion on why you shouldn&rsquo;t need this should be happening however), or perhaps you have something hosted internally that you can&rsquo;t quite open up to GitHub Actions externally that you need to access during your build. Whatever the reason, GitHub at least provides you the opportunity to host your own for whatever the situation. While the documentation is good, it&rsquo;s not exactly great. That is, if you want to do anything other than use their built-in scripts and assumptions. If you truly need to customize how you are hosting things, then these tips may help you out a bit.</p><h2 id=the-directory-assumptions>The directory assumptions</h2><h3 id=home>HOME</h3><p>While you can technically have any user run the runner application, there are a few actions and tools that make the assumption that your home directory is <code>/home/runner</code>. If you choose to use another user other than <code>runner</code> simply linking your home directory to <code>/home/runner</code> should make sure all is well.</p><h3 id=agent_toolsdirectory>AGENT_TOOLSDIRECTORY</h3><p>This assumption is two fold. First off, that you have exported an environment variable with the name <code>AGENT_TOOLSDIRECTORY</code>, and that it always has a value of <code>/opt/hostedtoolcache</code>. Sadly, this is hardcoded in quite a few places in various actions as a left over from GitHub&rsquo;s own runners. This particularly is assumed in most of the language runtime actions, like <a href=https://github.com/actions/setup-python>actions/setup-python</a>. You also have to make sure that this directory exists, and that whichever user you chose to run the runner has permissions to it.</p><h3 id=a-work-directory>A work directory</h3><p>To enable being able to clear out things between action runs, we&rsquo;ll want a separate work directory. One of the features listed in the official documentation is &ldquo;Don&rsquo;t need to have a clean instance for every job execution&rdquo; so you don&rsquo;t need to clear this out, but should you wish to, you&rsquo;ll want to set this up separately from say, your home directory.</p><h2 id=dependencies>Dependencies</h2><p>The runner package has a <code>./bin/installdependencies.sh</code>, which should install most dependencies required for the runner. This doesn&rsquo;t necessarily install packages that will be required for most actions. So, we&rsquo;ll want to install a few more. Assuming you are using debian/ubuntu base, you&rsquo;ll want:</p><ul><li>git</li><li>libyaml</li><li>buildessential</li></ul><p>We&rsquo;ll also want a few more things to script out how we start up the runner</p><ul><li>curl</li><li>jq</li></ul><p>Additionally, you&rsquo;ll absolutely want to make sure that the time on whatever system you choose is synced to a timeserver. Any issues with time will prevent the runner from registering with GitHub.</p><h2 id=runner-startup-process>Runner startup process</h2><h3 id=registration>Registration</h3><p>To properly register a runner with GitHub, you have to do some token exchange. This starts with having a <a href=https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token>GitHub personal access token</a>. Once you have that, you next have to use it to get a specific registration token for your runner. So, let&rsquo;s register a runner for our whole organization.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>GITHUB_TOKEN<span style=color:#f92672>=</span>MY_TOKEN_HERE
OWNER<span style=color:#f92672>=</span>MY_GITHUB_ORG
<span style=color:#75715e># Get runner authentication token</span>
REGISTRATION_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -XPOST <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -H <span style=color:#e6db74>&#34;authorization: token </span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    <span style=color:#e6db74>&#34;https://api.github.com/orgs/</span><span style=color:#e6db74>${</span>OWNER<span style=color:#e6db74>}</span><span style=color:#e6db74>/actions/runners/registration-token&#34;</span> | jq -r .token<span style=color:#66d9ef>)</span>
</code></pre></div><h3 id=configuration>Configuration</h3><p>Next, you can configure and start up your runner by providing the proper parameters, including your token. You&rsquo;ll want to call the <code>config.sh</code> script included in the runner package.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>WORKDIR<span style=color:#f92672>=</span>/my/workdir/path
mkdir -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>WORKDIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
./config.sh <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      --url <span style=color:#e6db74>&#34;https://github.com/</span><span style=color:#e6db74>${</span>OWNER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      --token <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>REGISTRATION_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      --name <span style=color:#e6db74>&#34;MY_RUNNER_NAME&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      --work <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>WORKDIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      --replace
</code></pre></div><h3 id=starting>Starting</h3><p>By providing a particular parameter to the included <code>./run.sh</code> you can have the runner exit once an single action has run on your runner. Using this mechanism along with system level control that forces the runner to always be running, we can clean up after ourselves after exit, and unregister our runner. We can make this a function to trap on in our script.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cleanup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e># Deregister the runner from github</span>
  REGISTRATION_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -XPOST <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      -H <span style=color:#e6db74>&#34;authorization: token </span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>      <span style=color:#e6db74>&#34;https://api.github.com/orgs/</span><span style=color:#e6db74>${</span>OWNER<span style=color:#e6db74>}</span><span style=color:#e6db74>/actions/runners/registration-token&#34;</span> | jq -r .token<span style=color:#66d9ef>)</span>
  ./config.sh remove --token <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>REGISTRATION_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>

  <span style=color:#75715e># Remove our runner work dir to clean up after ourselves</span>
  rm -rf <span style=color:#e6db74>${</span>WORKDIR<span style=color:#e6db74>}</span>
<span style=color:#f92672>}</span>

trap cleanup EXIT
./run.sh --once
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>If you want to run Docker based actions, you will also have docker installed, in the path, and you&rsquo;ll want to add some parts to clean up docker volumes and images. If you decide to try to create a docker container to start up a runner, keep in mind that you&rsquo;ll have to deal with docker-in-docker issues if you use docker-based actions. You can try to keep a runner up once it exits by creating a <code>systemd</code> service with <code>Restart=always</code>. Want to run a bunch on a large system, then make sure that you give them different names. With the <code>--replace</code> parameter, if you use the same name, any new runner that registers itself will just do what you told it to do, replace the last one with the same name.</p><p>Hopefully this helps you with your own self-hosted runners if you want to control the process a bit more than what is included in the main documentation.</p></div><div class=post-footer></div></article></main></body></html>